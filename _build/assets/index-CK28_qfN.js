import{$,G as se,H as N,e as ve,b as Z,I as ae,q as x,J as ye,d as A,K as f,z as k,w as ie,L as Ce,c as Y,m as be,t as _e,x as v,i as me,y as B,p as J,D as m,j as p,M as re,S as $e}from"./web-BVNkkRQA.js";const X=Symbol("store-raw"),T=Symbol("store-node"),C=Symbol("store-has"),ce=Symbol("store-self");function he(t){let e=t[$];if(!e&&(Object.defineProperty(t,$,{value:e=new Proxy(t,Se)}),!Array.isArray(t))){const n=Object.keys(t),o=Object.getOwnPropertyDescriptors(t);for(let s=0,i=n.length;s<i;s++){const r=n[s];o[r].get&&Object.defineProperty(t,r,{enumerable:o[r].enumerable,get:o[r].get.bind(e)})}}return e}function K(t){let e;return t!=null&&typeof t=="object"&&(t[$]||!(e=Object.getPrototypeOf(t))||e===Object.prototype||Array.isArray(t))}function O(t,e=new Set){let n,o,s,i;if(n=t!=null&&t[X])return n;if(!K(t)||e.has(t))return t;if(Array.isArray(t)){Object.isFrozen(t)?t=t.slice(0):e.add(t);for(let r=0,a=t.length;r<a;r++)s=t[r],(o=O(s,e))!==s&&(t[r]=o)}else{Object.isFrozen(t)?t=Object.assign({},t):e.add(t);const r=Object.keys(t),a=Object.getOwnPropertyDescriptors(t);for(let l=0,d=r.length;l<d;l++)i=r[l],!a[i].get&&(s=t[i],(o=O(s,e))!==s&&(t[i]=o))}return t}function H(t,e){let n=t[e];return n||Object.defineProperty(t,e,{value:n=Object.create(null)}),n}function M(t,e,n){if(t[e])return t[e];const[o,s]=Z(n,{equals:!1,internal:!0});return o.$=s,t[e]=o}function xe(t,e){const n=Reflect.getOwnPropertyDescriptor(t,e);return!n||n.get||!n.configurable||e===$||e===T||(delete n.value,delete n.writable,n.get=()=>t[$][e]),n}function de(t){N()&&M(H(t,T),ce)()}function ke(t){return de(t),Reflect.ownKeys(t)}const Se={get(t,e,n){if(e===X)return t;if(e===$)return n;if(e===se)return de(t),n;const o=H(t,T),s=o[e];let i=s?s():t[e];if(e===T||e===C||e==="__proto__")return i;if(!s){const r=Object.getOwnPropertyDescriptor(t,e);N()&&(typeof i!="function"||t.hasOwnProperty(e))&&!(r&&r.get)&&(i=M(o,e,i)())}return K(i)?he(i):i},has(t,e){return e===X||e===$||e===se||e===T||e===C||e==="__proto__"?!0:(N()&&M(H(t,C),e)(),e in t)},set(){return!0},deleteProperty(){return!0},ownKeys:ke,getOwnPropertyDescriptor:xe};function U(t,e,n,o=!1){if(!o&&t[e]===n)return;const s=t[e],i=t.length;n===void 0?(delete t[e],t[C]&&t[C][e]&&s!==void 0&&t[C][e].$()):(t[e]=n,t[C]&&t[C][e]&&s===void 0&&t[C][e].$());let r=H(t,T),a;if((a=M(r,e,s))&&a.$(()=>n),Array.isArray(t)&&t.length!==i){for(let l=t.length;l<i;l++)(a=r[l])&&a.$();(a=M(r,"length",i))&&a.$(t.length)}(a=r[ce])&&a.$()}function fe(t,e){const n=Object.keys(e);for(let o=0;o<n.length;o+=1){const s=n[o];U(t,s,e[s])}}function Pe(t,e){if(typeof e=="function"&&(e=e(t)),e=O(e),Array.isArray(e)){if(t===e)return;let n=0,o=e.length;for(;n<o;n++){const s=e[n];t[n]!==s&&U(t,n,s)}U(t,"length",o)}else fe(t,e)}function F(t,e,n=[]){let o,s=t;if(e.length>1){o=e.shift();const r=typeof o,a=Array.isArray(t);if(Array.isArray(o)){for(let l=0;l<o.length;l++)F(t,[o[l]].concat(e),n);return}else if(a&&r==="function"){for(let l=0;l<t.length;l++)o(t[l],l)&&F(t,[l].concat(e),n);return}else if(a&&r==="object"){const{from:l=0,to:d=t.length-1,by:c=1}=o;for(let h=l;h<=d;h+=c)F(t,[h].concat(e),n);return}else if(e.length>1){F(t[o],e,[o].concat(n));return}s=t[o],n=[o].concat(n)}let i=e[0];typeof i=="function"&&(i=i(s,n),i===s)||o===void 0&&i==null||(i=O(i),o===void 0||K(s)&&K(i)&&!Array.isArray(i)?fe(s,i):U(t,o,i))}function Te(...[t,e]){const n=O(t||{}),o=Array.isArray(n),s=he(n);function i(...r){ve(()=>{o&&r.length===1?Pe(n,r[0]):F(n,r)})}return[s,i]}const Ee="_canvasContainer_alcme_1",Ae="_canvasWrapper_alcme_7",ze="_canvas_alcme_1",G={canvasContainer:Ee,canvasWrapper:Ae,canvas:ze},y=["#FFF1E8","#000000","#FFCCAA","#1D2B53","#7E2553","#008751","#AB5236","#5F574F","#C2C3C7","#FF004D","#FFA300","#FFEC27","#00E436","#29ADFF","#83769C","#FF77A8"],De=t=>{const e=parseInt(t.slice(1),16),n=e>>16&255,o=e>>8&255,s=e&255;return{r:n,g:o,b:s}};class E{x;y;constructor(e,n){this.x=e,this.y=n}set(e,n){this.x=e,this.y=n}}const g={LEFT:0,WHEEL:1,RIGHT:2};class Le{panning;panToggle;canvasTransform;constructor(e){this.canvasTransform={pan:new E(0,0),zoom:1},this.panning=!1,this.panToggle=!1}}const ue=(t,e,n)=>{const o=new Uint8Array(3);return o[0]=t>>2&255,o[1]=(t&3)<<6|e>>4&63,o[2]=(e&15)<<4|n&15,o},ge=t=>{const e=(t[0]&255)<<2|t[1]>>6&3,n=(t[1]&63)<<4|t[2]>>4&15,o=t[2]&15;return{x:e,y:n,colorIndex:o}},Fe=(t,e)=>{const n=e*e,o=new Uint8ClampedArray(n*4);for(let s=0;s<n;s++){const i=t.slice(s*3,s*3+3),{colorIndex:r}=ge(i),{r:a,g:l,b:d}=De(y[r]);o[s*4+0]=a,o[s*4+1]=l,o[s*4+2]=d,o[s*4+3]=255}return new ImageData(o,e,e)},P=256;let Oe=class{element;context;editor;buffer;bufferCanvas;bufferContext;constructor({canvasElement:e,editor:n}){this.editor=n,this.element=e,this.element.width=P,this.element.height=P,this.context=e.getContext("2d");const o=P*P;this.buffer=new Uint8Array(o*3),this.bufferCanvas=new OffscreenCanvas(this.element.width,this.element.height),this.bufferContext=this.bufferCanvas.getContext("2d"),this.bufferContext.fillStyle=y[0],this.bufferContext.fillRect(0,0,this.element.width,this.element.height)}getImageData(e){return Fe(e,P)}updateBuffer(e){this.buffer.set(e),this.drawBuffer()}getPencilFillRect(e){return[e.coords.x-e.size/2,e.coords.y-e.size/2,e.size,e.size]}applyChanges(e){e.forEach(n=>{const o=n,s=o.size===1?0:o.size/2,i=o.coords.x-s,r=o.coords.y-s;for(let a=r;a<r+o.size;a++)for(let l=i;l<i+o.size;l++){const d=(a*P+l)*3;let c=y.findIndex(b=>b===n.color);c===-1&&(c=0);const h=ue(n.coords.x,n.coords.y,c);this.buffer.set(h,d)}})}drawBuffer(){const e=this.getImageData(this.buffer);this.bufferContext.putImageData(e,0,0),this.context.drawImage(this.bufferCanvas,0,0)}drawPencilPreview(){const e=this.editor.pencil.activeKey===g.LEFT?this.editor.pencil.primaryColor:this.editor.pencil.secondaryColor;this.context.fillStyle=e;const n=this.editor.pencil,o=n.size===1?0:n.size/2;this.context.fillRect(n.coords.x-o,n.coords.y-o,n.size,n.size)}draw(){this.drawBuffer(),this.drawPencilPreview()}};class Me{primaryColor;secondaryColor;size;initialCoords;offsetCoords;coords;isDown;activeKey;constructor(){this.primaryColor=y[1],this.secondaryColor=y[0],this.size=1,this.initialCoords=new E(0,0),this.offsetCoords=new E(0,0),this.coords=new E(0,0),this.isDown=!1,this.activeKey=g.LEFT}}class qe{editor;webSocket;queue;constructor(e){this.editor=e,this.webSocket=new WebSocket("ws://192.168.1.23:8080"),this.queue=[],this.registerListeners(),this.loop()}getPackedMessage(e){const n=e.reduce((i,r)=>i+r.length,0),o=new Uint8Array(n);let s=0;return e.forEach(i=>{o.set(i,s),s+=i.length}),o}appendChange(e){const n=[],o=e,s=o.size===1?0:o.size/2,i=o.coords.x-s,r=o.coords.y-s;for(let a=r;a<r+o.size;a++)for(let l=i;l<i+o.size;l++){let d=y.findIndex(h=>h===e.color);d===-1&&(d=0);const c=ue(e.coords.x,e.coords.y,d);n.push(c)}this.queue.push(...n)}sendChanges(){console.log(`Websocket: Sending ${this.queue.length} updates`);const e=this.getPackedMessage(this.queue);this.webSocket.send(e),this.queue=[]}async onReceive(e){const o=await e.data.arrayBuffer(),s=new Uint8Array(o),i=s.length/3,r=[];for(let a=0;a<i;a++){const l=3*a,d=s.slice(l,l+3),c=ge(d);r.push({color:y[c.colorIndex],coords:new E(c.x,c.y),size:1})}console.log(`Websocket: Received ${r.length} updates`),this.editor.queueChange(r)}loop(){this.queue.length>0&&this.sendChanges(),setTimeout(()=>{this.loop()},1e3)}registerListeners(){this.webSocket.addEventListener("open",()=>console.log("Websocket: Connected")),this.webSocket.addEventListener("message",e=>this.onReceive(e))}}let Ie=class{container;pencil;controls;socket;canvas;changes;constructor(e){this.container=e.parentElement,this.pencil=new Me,this.controls=new Le(e),this.socket=new qe(this),this.canvas=new Oe({canvasElement:e,editor:this}),this.changes=[],this.registerEventListeners(),this.init(),this.update()}async fetchLatestSnapshot(){const n=await(await fetch("http://192.168.1.23:3000/api/canvas")).arrayBuffer();return new Uint8Array(n)}async init(){const e=await this.fetchLatestSnapshot();this.canvas.updateBuffer(e)}queueUserChange(e){this.queueChange(e),this.socket.appendChange(e)}queueChange(e){Array.isArray(e)||(e=[e]),this.changes.push(...e)}onPointerDown(e){e.target===this.canvas.element&&(this.pencil.initialCoords.set(e.x,e.y),e.button===g.LEFT&&!this.controls.panToggle&&(this.pencil.isDown=!0,this.pencil.activeKey=g.LEFT,this.queueUserChange({coords:this.pencil.coords,color:this.pencil.primaryColor,size:this.pencil.size})),e.button===g.RIGHT&&(this.pencil.isDown=!0,this.pencil.activeKey=g.RIGHT,this.queueUserChange({coords:this.pencil.coords,color:q.secondaryColor,size:this.pencil.size}))),(e.button===g.WHEEL||this.controls.panToggle)&&(this.controls.panning=!0)}onPointerUp(e){this.pencil.isDown=!1,this.pencil.activeKey=g.LEFT,(e.button===g.WHEEL||this.controls.panToggle)&&(this.controls.panning=!1,this.controls.canvasTransform.pan.set(this.controls.canvasTransform.pan.x+this.pencil.offsetCoords.x,this.controls.canvasTransform.pan.y+this.pencil.offsetCoords.y),this.pencil.offsetCoords.set(0,0))}onPointerMove(e){const n=this.canvas.element.getBoundingClientRect();if(this.pencil.coords.set(Math.floor((e.x-n.left)/n.width*this.canvas.element.width),Math.floor((e.y-n.top)/n.height*this.canvas.element.height)),this.pencil.isDown){const o=this.pencil.activeKey===g.LEFT?this.pencil.primaryColor:this.pencil.secondaryColor;this.queueUserChange({coords:this.pencil.coords,color:o,size:this.pencil.size})}this.controls.panning&&this.pencil.offsetCoords.set(e.x-this.pencil.initialCoords.x,e.y-this.pencil.initialCoords.y)}onWheel(e){if(e.preventDefault(),!(e.deltaX>0&&e.deltaY>0)){const o=this.controls.canvasTransform.zoom+e.deltaY*-.01;this.controls.canvasTransform.zoom=o<.5?.5:o}}onKeyDown(e){e.code==="Space"&&(this.controls.panToggle=!0)}onKeyUp(e){e.code==="Space"&&(this.controls.panToggle=!1)}applyTransform(){const e=new E(this.controls.canvasTransform.pan.x+this.pencil.offsetCoords.x,this.controls.canvasTransform.pan.y+this.pencil.offsetCoords.y);this.container.style.transform=`scale(${this.controls.canvasTransform.zoom}) translate(${e.x}px, ${e.y}px)`}update(){this.applyTransform(),this.canvas.applyChanges(this.changes),this.changes=[],this.canvas.draw(),requestAnimationFrame(()=>this.update())}registerEventListeners(){window.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("pointerdown",e=>this.onPointerDown(e)),window.addEventListener("pointerup",e=>this.onPointerUp(e)),window.addEventListener("pointermove",e=>this.onPointerMove(e)),window.addEventListener("wheel",e=>this.onWheel(e),{passive:!1}),window.addEventListener("keydown",e=>this.onKeyDown(e)),window.addEventListener("keyup",e=>this.onKeyUp(e))}};var Re=k("<div><div><canvas>");const je=()=>{let t;const e=n=>{t=new Ie(n)};return ae(()=>{t.pencil.primaryColor=q.primaryColor,t.pencil.secondaryColor=q.secondaryColor}),(()=>{var n=x(Re),o=n.firstChild,s=o.firstChild;return ye(e,s),A(i=>{var r=G.canvasContainer,a=G.canvasWrapper,l=G.canvas;return r!==i.e&&f(n,i.e=r),a!==i.t&&f(o,i.t=a),l!==i.a&&f(s,i.a=l),i},{e:void 0,t:void 0,a:void 0}),n})()},Ke="_editor_dxltd_1",He={editor:Ke};var Ue=k("<svg stroke-width=0>");function we(t,e){const n=ie(t.a,e),[o,s]=Ce(n,["src"]),[i,r]=Z(""),a=Y(()=>e.title?`${t.c}<title>${e.title}</title>`:t.c);return ae(()=>r(a())),be(()=>{r("")}),(()=>{var l=x(Ue);return _e(l,ie({get stroke(){return t.a?.stroke},get color(){return e.color||"currentColor"},get fill(){return e.color||"currentColor"},get style(){return{...e.style,overflow:"visible"}}},s,{get height(){return e.size||"1em"},get width(){return e.size||"1em"},xmlns:"http://www.w3.org/2000/svg",get innerHTML(){return i()}}),!0,!0),v(l,()=>me),B(),l})()}function W(t){return we({a:{xmlns:"http://www.w3.org/2000/svg",class:"icon icon-tabler icon-tabler-caret-down",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},c:'<path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6 10l6 6l6 -6h-12"/>'},t)}function We(t){return we({a:{xmlns:"http://www.w3.org/2000/svg",class:"icon icon-tabler icon-tabler-help",width:"24",height:"24",viewBox:"0 0 24 24","stroke-width":"2",stroke:"currentColor",fill:"none","stroke-linecap":"round","stroke-linejoin":"round"},c:'<path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"/><path d="M12 17l0 .01"/><path d="M12 13.5a1.5 1.5 0 0 1 1 -1.5a2.6 2.6 0 1 0 -3 -4"/>'},t)}const Be="_title_12w0k_21",Ge="_logo_12w0k_28",Ne="_button_12w0k_35",Ye="_icon_12w0k_40",D={interface:"_interface_12w0k_1",title:Be,logo:Ge,button:Ne,icon:Ye},Xe="_manual_1qmbt_1",Ze="_close_1qmbt_14",Je="_shortcut_1qmbt_27",Qe="_symbol_1qmbt_35",_={manual:Xe,close:Ze,shortcut:Je,symbol:Qe};var Ve=k("<div><button>Fermer</button><ul><li><span>Clic Gauche</span>Peindre la couleur principale <!$><!/></li><li><span>Clic Gauche</span>Peindre la couleur secondaire <!$><!/></li><li><span>Clic Molette</span>Deplacer la toile</li><li><span>Scroll</span>Zoom +/-");const et=t=>(()=>{var e=x(Ve),n=e.firstChild,o=n.nextSibling,s=o.firstChild,i=s.firstChild,r=i.nextSibling,a=r.nextSibling,[l,d]=m(a.nextSibling),c=s.nextSibling,h=c.firstChild,b=h.nextSibling,S=b.nextSibling,[w,I]=m(S.nextSibling),z=c.nextSibling,R=z.firstChild,j=z.nextSibling,pe=j.firstChild;return n.$$click=()=>{t.setManual(!1)},v(s,p(W,{get class(){return _.symbol},color:"white",fill:"white","stroke-width":1}),l,d),v(c,p(W,{get class(){return _.symbol},color:"white","stroke-width":1}),w,I),A(u=>{var Q=_.manual,V=_.close,ee=_.shortcut,te=_.shortcut,ne=_.shortcut,oe=_.shortcut;return Q!==u.e&&f(e,u.e=Q),V!==u.t&&f(n,u.t=V),ee!==u.a&&f(i,u.a=ee),te!==u.o&&f(h,u.o=te),ne!==u.i&&f(R,u.i=ne),oe!==u.n&&f(pe,u.n=oe),u},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),B(),e})();J(["click"]);const tt="_palette_18fr4_1",nt="_colorContainer_18fr4_7",ot="_colorState_18fr4_11",st="_color_18fr4_7",L={palette:tt,colorContainer:nt,colorState:ot,color:st};var it=k("<div>"),rt=k("<div><!$><!/><!$><!/><button>");const lt=()=>{const t=e=>n=>{n.preventDefault(),n.button===g.LEFT&&le("primaryColor",e),n.button===g.RIGHT&&le("secondaryColor",e)};return(()=>{var e=x(it);return v(e,()=>y.map(n=>(()=>{var o=x(rt),s=o.firstChild,[i,r]=m(s.nextSibling),a=i.nextSibling,[l,d]=m(a.nextSibling),c=l.nextSibling;return v(o,(()=>{var h=Y(()=>n===q.primaryColor);return()=>h()&&p(W,{get class(){return L.colorState},color:"white",fill:"white","stroke-width":1})})(),i,r),v(o,(()=>{var h=Y(()=>n===q.secondaryColor);return()=>h()&&p(W,{get class(){return L.colorState},color:"white","stroke-width":1})})(),l,d),re(c,"click",t(n),!0),re(c,"contextmenu",t(n),!0),n!=null?c.style.setProperty("background",n):c.style.removeProperty("background"),A(h=>{var b=L.colorContainer,S=L.color;return b!==h.e&&f(o,h.e=b),S!==h.t&&f(c,h.t=S),h},{e:void 0,t:void 0}),B(),o})())),A(()=>f(e,L.palette)),e})()};J(["contextmenu","click"]);var at=k('<div><header><div><img src=/assets/images/logo.png alt=""><span>MochiPlace</span></div><!$><!/><button></button></header><!$><!/>');const ct=()=>{const[t,e]=Z(!0),n=()=>e(o=>!o);return(()=>{var o=x(at),s=o.firstChild,i=s.firstChild,r=i.firstChild,a=i.nextSibling,[l,d]=m(a.nextSibling),c=l.nextSibling,h=s.nextSibling,[b,S]=m(h.nextSibling);return v(s,p(lt,{}),l,d),c.$$click=n,v(c,p(We,{get class(){return D.icon}})),v(o,p($e,{get when(){return t()},get children(){return p(et,{setManual:e})}}),b,S),A(w=>{var I=D.interface,z=D.title,R=D.logo,j=D.button;return I!==w.e&&f(o,w.e=I),z!==w.t&&f(i,w.t=z),R!==w.a&&f(r,w.a=R),j!==w.o&&f(c,w.o=j),w},{e:void 0,t:void 0,a:void 0,o:void 0}),B(),o})()};J(["click"]);var ht=k("<div><!$><!/><!$><!/>");const[q,le]=Te({primaryColor:y[1],secondaryColor:y[0],size:1}),dt=()=>(()=>{var t=x(ht),e=t.firstChild,[n,o]=m(e.nextSibling),s=n.nextSibling,[i,r]=m(s.nextSibling);return v(t,p(ct,{}),n,o),v(t,p(je,{}),i,r),A(()=>f(t,He.editor)),t})();function wt(){return p(dt,{})}export{wt as default};
//# sourceMappingURL=index-CK28_qfN.js.map
